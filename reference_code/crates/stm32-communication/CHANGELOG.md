# 更新日志

## [0.1.0] - 2024-12-XX - 协议升级版本

### 🎯 主要更新

#### 新增功能
- ✨ **舵机双轴控制**: 新增X/Y轴舵机角度控制功能
  - 角度范围: 30.0° - 150.0°
  - 默认位置: 90.0° (中心位置)
  - 支持单轴和双轴同时控制
  - 浮点数精度角度设置

- ✨ **镜头锁定控制**: 新增镜头锁定状态管理
  - 支持镜头锁定/解锁状态切换
  - 锁定后可通过摇杆控制方向
  - 支持舵机角度控制命令下发

- ✨ **镜头调节速度**: 新增3档调节速度控制
  - 0: 快调
  - 1: 慢调
  - 2: 微调 (新增)

#### 协议变更
- 🔄 **亮度控制范围**: 从0-1279更新为0-5等级制
  - 0: 关闭 (0%)
  - 1: 低亮度 (20%)
  - 2: 中低亮度 (40%)
  - 3: 中等亮度 (60%)
  - 4: 高亮度 (80%)
  - 5: 最大亮度 (100%)

- 🔄 **数据包结构**: 扩展协议支持新字段
  - 舵机X轴角度 (字节11-14): float类型
  - 舵机Y轴角度 (字节15-18): float类型
  - 保持向后兼容性

#### API增强
- 🚀 **控制器接口**: 新增舵机和镜头控制API
  ```rust
  // 舵机控制
  controller.set_servo_x_angle(45.0)?;
  controller.set_servo_y_angle(135.0)?;
  controller.set_servo_angles(60.0, 120.0)?;
  controller.reset_servo_angles()?;
  
  // 镜头控制
  controller.set_lens_locked(true)?;
  controller.set_lens_speed(2)?; // 微调
  ```

- 🚀 **设备管理器**: 扩展设备参数和状态管理
  - 新增舵机角度验证 (30.0°-150.0°)
  - 新增镜头速度验证 (0-2)
  - 增强状态变化监控

#### 测试覆盖
- 🧪 **新增测试用例**: 全面覆盖新功能
  - 舵机角度控制测试
  - 镜头锁定和速度控制测试
  - 协议数据包构建和解析测试
  - 边界值和错误处理测试

- 🧪 **更新现有测试**: 适配新协议格式
  - 亮度等级测试 (0-5范围)
  - 设备能力测试 (6个亮度等级)
  - 数据包解析测试

#### 文档和示例
- 📚 **完整文档**: 新增README和使用指南
- 📚 **示例程序**: servo_control.rs演示新功能
- 📚 **API文档**: 详细的函数和结构体说明

### 🔧 技术改进

#### 代码质量
- 清理未使用的导入和变量
- 优化异步代码，移除不必要的tokio依赖
- 改进错误处理和日志记录
- 增强类型安全性

#### 性能优化
- 优化数据包构建和解析逻辑
- 减少内存分配和拷贝
- 改进CRC校验算法

### 🐛 修复问题

- 修复编译警告
- 修复测试用例中的数值范围问题
- 优化线程管理和资源清理

### 📋 兼容性

#### 向后兼容
- ✅ 保持现有API接口不变
- ✅ 支持旧版本设备通信
- ✅ 协议头和基本结构保持一致

#### 升级指南
1. 更新亮度控制代码使用新的0-5范围
2. 可选择使用新的舵机控制功能
3. 可选择使用新的镜头控制功能
4. 更新测试用例以适配新协议

### 🎯 下一步计划

- [ ] 添加更多舵机控制模式
- [ ] 支持舵机速度控制
- [ ] 添加设备固件版本检测
- [ ] 优化通信性能
- [ ] 添加配置文件支持

---

## 协议对比

### 旧协议 vs 新协议

| 功能 | 旧协议 | 新协议 | 变化 |
|------|--------|--------|------|
| 亮度控制 | 0-1279 | 0-5 | 简化为等级制 |
| 镜头锁定 | 基础支持 | 增强功能 | 新增摇杆控制 |
| 镜头速度 | 0-1 | 0-2 | 新增微调档位 |
| 舵机控制 | 无 | X/Y双轴 | 全新功能 |
| 角度范围 | 无 | 30°-150° | 全新功能 |
| 数据包大小 | 32字节 | 32字节 | 保持不变 |

### 新增字段映射

| 字段 | 字节偏移 | 长度 | 类型 | 说明 |
|------|----------|------|------|------|
| 舵机X轴角度 | 11-14 | 4 | float | 30.0-150.0° |
| 舵机Y轴角度 | 15-18 | 4 | float | 30.0-150.0° |
| 保留字段 | 19-29 | 11 | - | 未来扩展 |
